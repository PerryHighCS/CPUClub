<!doctype html>
<html>
    <head>
        <title>Perry High CPU Club</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <!-- bootstrap and jquery -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>

        <!-- firebase -->
        <script src="https://www.gstatic.com/firebasejs/4.6.0/firebase.js"></script>
        <script src="https://www.gstatic.com/firebasejs/4.6.0/firebase-app.js"></script>
        <script src="https://www.gstatic.com/firebasejs/4.6.0/firebase-auth.js"></script>
        <script src="https://www.gstatic.com/firebasejs/4.6.0/firebase-firestore.js"></script>        
        <script src="https://cdn.firebase.com/libs/firebaseui/2.4.1/firebaseui.js"></script>

        <script>
            // Initialize Firebase
            var config = {
                apiKey: "AIzaSyBE65o0OWjJmWeEIu8tqkVHpaEAuhy9I_c",
                authDomain: "phs-cpuclub-portfolio.firebaseapp.com",
                databaseURL: "https://phs-cpuclub-portfolio.firebaseio.com",
                projectId: "phs-cpuclub-portfolio"
            };
            firebase.initializeApp(config);
            var db = firebase.firestore();
        </script>
        <script src="/CPUClub/auth.js"></script>        
        <link type="text/css" rel="stylesheet" href="https://cdn.firebase.com/libs/firebaseui/2.4.1/firebaseui.css" />

        <link rel="stylesheet" href="/CPUClub/style.css">

    </head>
    <body>
        <nav class="navbar navbar-inverse">
            <div class="container-fluid">
                <div class="navbar-header">
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#myNavbar">
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>                        
                    </button>
                    <a class="navbar-brand" href="#">Perry High CPU Club</a>
                </div>
                <div class="collapse navbar-collapse" id="myNavbar">
                    <ul class="nav navbar-nav">
                        <li><a href="#">Home</a></li>
                        <li><a href="#">About</a></li>
                        <li><a href="/CPUClubPortfolio">Projects Gallery</a></li>
                        <li style="display: none;" class="admin active"><a href="/CPUClub/admin.html">Admin</a></li>
                    </ul>
                    <ul class="nav navbar-nav navbar-right">
                        <li id="sign-in"><a href="#" data-toggle="modal" data-target="#loginModal"><span class="glyphicon glyphicon-log-in"></span>&nbsp;Sign in</a></li>
                        <li id="sign-out"><a href="#" onclick="firebase.auth().signOut();"> <span class="glyphicon glyphicon-log-out"></span>&nbsp;Sign out <span id="username"></span></a></li>
                    </ul>
                </div>
            </div>
        </nav>

        <div class="container-fluid bg-3 text-center"> 
            <h3>Perry High CPU Club</h3>
        </div>

        <div class="container-fluid">
            <h2>Membership Roster:</h2>
            <div id="membership">                
                <h2>You must be an admin to access the membership roster.</h2>
            </div>
        </div>

        <div class="modal fade" id="loginModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                        <h4 class="modal-title">Login</h4>
                    </div>
                    <div class="modal-body">
                        <div id="firebaseui-auth-container"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    </div>
                </div>
            </div>
        </div>


        <footer class="container-fluid text-center">
            <p>Copyright &copy; 2017 Perry High CPU Club.</p>
        </footer>
        
        <script>
            let users = [];
            let admin = [];
            let members = [];

            function loadMembership() {
                let MEMBER_TABLE = "<table class='table table-striped'>\n\
        <thead>\n\
            <th>Pic</th><th>Name</th><th>Affiliation</th><th>Member</th><th>Admin</th>\n\
        </thead>\n\
        </table>";
                let userColl = db.collection('users');
                
                userColl.get().then(function(docs) {
                    docs.forEach((doc) => {
                        let data = doc.data();
                        
                        if (doc.id === 'Roles') {
                            admin = data.admin;
                            members = data.member;
                        }
                        else {
                            data.uid = doc.id;
                            users.push(data);
                        }
                    });
                    
                                       
                    let membership = $(MEMBER_TABLE);
                    $('#membership').empty();
                    $('#membership').append(membership);
                    
                    let tbody = $('<tbody>');
                    membership.append(tbody);
                                        
                    users.forEach((user) => {   
                        let row=$('<tr>');
                        tbody.append(row);
                        
                        let pic=$('<img src="' + user.pic + '">');
                        pic.addClass('memberpic');
                        
                        row.append($('<td>').append(pic));
                        
                        let nameBox = $('<input type="text"  class="form-control"></input>');
                        nameBox.prop('value', user.name);
                        nameBox.attr('id', 'name_' + user.uid);
                        nameBox.change(() => updateUser('name', user.uid));
                        nameBox.on('input', () => changed('name_' + user.uid ));
                        
                        row.append($('<td>').append(nameBox));
                        
                        
                        let affiliationBox = $('<input type="text"  class="form-control"></input>');
                        affiliationBox.prop('value', user.affiliation);
                        affiliationBox.attr('id', 'affiliation_' + user.uid);
                        affiliationBox.change(() => updateUser('affiliation', user.uid));
                        affiliationBox.on('input', () => changed('affiliation_' + user.uid ));
                        
                        row.append($('<td>').append(affiliationBox));
                        
                        
                        let memberBox = $('<input type="checkbox"></input>');
                        memberBox.prop('checked', members.indexOf(user.uid) >= 0);
                        memberBox.attr('id', 'member_' + user.uid);
                        memberBox.click(() => toggleMember(user.uid));
                        row.append($('<td>').append(memberBox));
                        
                        let adminBox = $('<input type="checkbox"></input>');
                        adminBox.prop('checked', admin.indexOf(user.uid) >= 0);
                        adminBox.attr('id', 'admin_' + user.uid);
                        adminBox.click(() => toggleAdmin(user.uid));
                        row.append($('<td>').append(adminBox));                        
                    });
                });
            }
            
            /**
             * Set whether a given user is admin, based on a checkbox
             * 
             * @param {String} uid 
             */
            function toggleAdmin(uid) {
                let adminBox = $("#admin_" + uid);
                
                // Determine if the user should be made admin (is the checkbox checked)
                let isSet = adminBox.prop('checked');
                
                // Determine where in the admin array the uid currently exists
                let userLoc = admin.indexOf(uid);
                
                // Remove the uid from the admin array
                if (userLoc >= 0) {
                    admin.splice(userLoc, 1);
                }
                
                // If the user should be admin
                if (isSet) {
                    // add the uid to the admin array
                    admin.push(uid);
                }
                
                // Update the admin roles in the database
                db.collection('users').doc('Roles').update({ admin : admin })
                        .then(() => adminBox.removeClass('changed'));                
            }
            
            function toggleMember(uid) {
                let memberBox =  $("#member_" + uid);
                // Determine if the user should be made a member (is the checkbox checked)
                let isSet = memberBox.prop('checked');
                memberBox.addClass('changed');

                // Determine where in the members array the uid currently exists
                let userLoc = members.indexOf(uid);
                
                // Remove the uid from the member array
                if (userLoc >= 0) {
                    members.splice(userLoc, 1);
                }
                
                // If the user should be a member
                if (isSet) {
                    // add the uid to the member array
                    members.push(uid);
                }
                
                // Update the membership roles in the database
                db.collection('users').doc('Roles').update({ member : members })
                        .then(() => memberBox.removeClass('changed')); 
            }
            
            function updateUser(key, uid) {
                let item = $("#" + key + "_" + uid);
                let newData = item.prop('value');
                let updateMap = {};
                updateMap[key] = newData;
                
                db.collection('users').doc(uid).update(updateMap)
                        .then(() => item.removeClass('changed'));
            }
            
            function changed(id) {
                $('#' + id).addClass('changed');
            }

            window.addEventListener('load', function () {
                loadMembership();
            });
        </script>
    </body>
</html>
